<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Totem Bot Admin Panel</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { margin: 40px; }
        .form-section { max-width: 500px; margin-bottom: 30px; }
        .table-section { max-width: 900px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Totem Bot Admin Panel</h1>
            <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
        <form id="unifiedForm" enctype="multipart/form-data" class="form-section card p-4 shadow-sm">
            <h2 class="mb-3">Send Message, Images, and Videos</h2>
            <div class="mb-3">
                <label class="form-label">Select Users:</label>
                <select id="unifiedUserSelect" name="user_ids" multiple class="form-select" style="height:100px;"></select>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="unifiedAllUsers">
                <label class="form-check-label" for="unifiedAllUsers">Send to All Users</label>
            </div>
            <div class="mb-3">
                <label class="form-label">Message:</label>
                <textarea id="unifiedMessage" name="message" class="form-control" rows="5" style="min-height:120px;"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Images:</label>
                <input type="file" id="unifiedImageFile" name="images" accept="image/*" class="form-control" multiple>
            </div>
            <div class="mb-3">
                <label class="form-label">Videos:</label>
                <input type="file" id="unifiedVideoFile" name="videos" accept="video/*" class="form-control" multiple>
            </div>
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
        <div id="result" class="mt-3"></div>
        <div id="authError" class="text-danger mt-2"></div>
        <h2 class="mt-5">Conversation/Reply Management</h2>
        <form id="addReplyForm" class="row g-2 align-items-center mb-3">
            <div class="col-auto">
                <input type="text" id="questionInput" placeholder="Common question" required class="form-control">
            </div>
            <div class="col-auto">
                <input type="text" id="replyInput" placeholder="Bot reply" required class="form-control">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-success">Add Reply</button>
            </div>
        </form>
        <div class="table-section">
            <table id="replyTable" class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                    <tr><th>Question</th><th>Reply</th><th>Active</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <h2 class="mt-5">User Overview</h2>
        <div class="table-section">
            <table id="userTable" class="table table-bordered table-striped align-middle">
                <thead class="table-light">
                    <tr><th>Telegram ID</th><th>Username</th><th>Last Seen</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ...existing JavaScript from admin_panel.html...
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        async function loadReplies() {
            const res = await fetch('/replies');
            if (res.status === 401) {
                document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                setTimeout(() => window.location.href = '/admin/login', 1500);
                return;
            }
            const data = await res.json();
            const tbody = document.getElementById('replyTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.replies.forEach(r => {
                const tr = document.createElement('tr');
                // ...existing code...
                const tdQ = document.createElement('td');
                const inputQ = document.createElement('input');
                inputQ.value = r.question;
                tdQ.appendChild(inputQ);
                tr.appendChild(tdQ);
                const tdR = document.createElement('td');
                const inputR = document.createElement('input');
                inputR.value = r.reply;
                tdR.appendChild(inputR);
                tr.appendChild(tdR);
                const tdA = document.createElement('td');
                const inputA = document.createElement('input');
                inputA.type = 'checkbox';
                inputA.checked = r.active;
                tdA.appendChild(inputA);
                tr.appendChild(tdA);
                const tdAct = document.createElement('td');
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = async () => {
                    await fetch(`/replies/${r.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({
                            question: inputQ.value,
                            reply: inputR.value,
                            active: inputA.checked
                        })
                    });
                    loadReplies();
                };
                tdAct.appendChild(saveBtn);
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.onclick = async () => {
                    await fetch(`/replies/${r.id}`, { method: 'DELETE', headers: { 'X-CSRF-Token': csrfToken } });
                    loadReplies();
                };
                tdAct.appendChild(delBtn);
                tr.appendChild(tdAct);
                tbody.appendChild(tr);
            });
        }
        document.getElementById('addReplyForm').onsubmit = async function(e) {
            e.preventDefault();
            const question = document.getElementById('questionInput').value;
            const reply = document.getElementById('replyInput').value;
            await fetch('/replies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ question, reply })
            });
            document.getElementById('questionInput').value = '';
            document.getElementById('replyInput').value = '';
            loadReplies();
        };
        loadReplies();
        document.getElementById('logoutBtn').onclick = function() {
            fetch('/admin/logout').then(() => {
                window.location.href = '/admin/login';
            });
        };
        async function loadUsers() {
            try {
                const res = await fetch('/users');
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                const select = document.getElementById('unifiedUserSelect');
                select.innerHTML = '';
                data.users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.telegram_id;
                    option.text = u.username ? `${u.username} (${u.telegram_id})` : u.telegram_id;
                    select.appendChild(option);
                });
                const tbody = document.getElementById('userTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    const tdId = document.createElement('td');
                    tdId.textContent = u.telegram_id;
                    const tdUser = document.createElement('td');
                    tdUser.textContent = u.username || '';
                    const tdLast = document.createElement('td');
                    tdLast.textContent = u.last_message_time || '';
                    tr.appendChild(tdId);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdLast);
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('authError').innerText = 'Error loading users.';
            }
        }
        loadUsers();
        document.getElementById('unifiedAllUsers').onchange = function() {
            document.getElementById('unifiedUserSelect').disabled = this.checked;
        };
        document.getElementById('unifiedForm').onsubmit = async function(e) {
            e.preventDefault();
            const all = document.getElementById('unifiedAllUsers').checked;
            let user_ids = [];
            if (!all) {
                user_ids = Array.from(document.getElementById('unifiedUserSelect').selectedOptions).map(o => o.value);
                if (user_ids.length === 0) {
                    document.getElementById('result').innerText = 'Please select at least one user or choose All Users.';
                    return;
                }
            }
            const message = document.getElementById('unifiedMessage').value;
            const imageFiles = document.getElementById('unifiedImageFile').files;
            const videoFiles = document.getElementById('unifiedVideoFile').files;
            if (!message && imageFiles.length === 0 && videoFiles.length === 0) {
                document.getElementById('result').innerText = 'Please provide at least a message, image, or video.';
                return;
            }
            const formData = new FormData();
            formData.append('message', message);
            formData.append('user_ids', all ? (await fetch('/users').then(r=>r.json())).users.map(u=>u.telegram_id).join(',') : user_ids.join(','));
            for (let i = 0; i < imageFiles.length; i++) {
                formData.append('images', imageFiles[i]);
            }
            for (let i = 0; i < videoFiles.length; i++) {
                formData.append('videos', videoFiles[i]);
            }
            const res = await fetch('/send/all/bulk', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken }, body: formData });
            let result = await res.json();
            if (result.success) {
                document.getElementById('result').innerText = ` Sent to ${result.sent.length} user(s).`;
            } else if (result.failed && result.failed.length > 0) {
                document.getElementById('result').innerText = `Some failed: ${JSON.stringify(result.failed)}`;
            } else {
                document.getElementById('result').innerText = JSON.stringify(result);
            }
        };
    </script>
</body>
</html>
