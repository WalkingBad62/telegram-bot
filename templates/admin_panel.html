<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem Bot Admin Panel</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Fraunces:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-1: #f6f4f1;
            --bg-2: #eef3fb;
            --ink: #1c1b1a;
            --muted: #5b5b62;
            --card: #ffffff;
            --accent: #2563eb;
            --accent-2: #10b981;
            --accent-3: #f59e0b;
            --border: rgba(17, 24, 39, 0.12);
            --shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Space Grotesk", system-ui, -apple-system, "Segoe UI", sans-serif;
            color: var(--ink);
            margin: 0;
            background:
                radial-gradient(900px 400px at 10% -10%, rgba(37, 99, 235, 0.12), transparent 60%),
                radial-gradient(800px 360px at 90% 10%, rgba(16, 185, 129, 0.12), transparent 60%),
                linear-gradient(140deg, var(--bg-1), var(--bg-2));
            min-height: 100vh;
        }
        .page-shell {
            padding: 48px 20px 72px;
        }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 26px;
        }
        .page-title {
            font-family: "Fraunces", "Times New Roman", serif;
            font-weight: 700;
            font-size: clamp(28px, 3.2vw, 44px);
            margin: 0;
            letter-spacing: -0.5px;
        }
        .page-subtitle {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 15px;
        }
        .btn-ghost {
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
            color: var(--ink);
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .btn-ghost:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
        }
        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 24px;
        }
        @media (min-width: 992px) {
            .grid {
                grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
                align-items: start;
            }
        }
        .panel-card {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 24px;
        }
        .panel-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 14px;
        }
        .panel-title span {
            color: var(--accent);
        }
        .form-section { max-width: none; }
        .table-section { max-width: none; }
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.1);
            color: #1e40af;
            font-size: 12px;
            font-weight: 600;
        }
        .form-control, .form-select {
            border-radius: 12px;
            border-color: rgba(17, 24, 39, 0.16);
            padding: 10px 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: rgba(37, 99, 235, 0.6);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #22c55e);
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 600;
        }
        #result {
            font-weight: 600;
            color: #1e40af;
        }
        #authError {
            font-weight: 600;
        }
        .table {
            margin-bottom: 0;
            border-radius: 14px;
            overflow: hidden;
        }
        .table thead {
            background: #f8fafc;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        #replyTable input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 6px 10px;
        }
        .reply-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        #replyTable button {
            border-radius: 999px;
            font-weight: 600;
            padding: 6px 14px;
            border: 1px solid transparent;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
        }
        #replyTable button .btn-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #replyTable button .btn-icon svg {
            width: 16px;
            height: 16px;
        }
        #replyTable button .btn-text {
            line-height: 1;
        }
        #replyTable button.btn-save {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(59, 130, 246, 0.22));
            color: #1d4ed8;
            border-color: rgba(37, 99, 235, 0.3);
        }
        #replyTable button.btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
        }
        #replyTable button.btn-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.14), rgba(248, 113, 113, 0.2));
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.25);
        }
        #replyTable button.btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.18);
        }
        #replyTable button:focus-visible {
            outline: 2px solid rgba(37, 99, 235, 0.35);
            outline-offset: 2px;
        }
        .confirm-modal .modal-content {
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .confirm-modal .modal-header {
            border-bottom: none;
        }
        .confirm-modal .modal-footer {
            border-top: none;
        }
        .confirm-modal .btn {
            border-radius: 999px;
            padding: 8px 16px;
            font-weight: 600;
        }
        .confirm-modal .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f97316);
            border: none;
        }
        .confirm-modal .btn-secondary {
            background: rgba(15, 23, 42, 0.08);
            border: none;
            color: #1f2937;
        }
        .confirm-details {
            margin-top: 12px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.04);
            border: 1px dashed rgba(15, 23, 42, 0.08);
            display: grid;
            gap: 10px;
            font-size: 13px;
        }
        .confirm-details .detail-row {
            display: grid;
            gap: 6px;
        }
        .confirm-details .detail-label {
            text-transform: uppercase;
            letter-spacing: 0.7px;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
        }
        .confirm-details .detail-value {
            color: #1f2937;
            word-break: break-word;
        }
        .link-button {
            background: none;
            border: none;
            color: #2563eb;
            font-weight: 600;
            padding: 6px 0 0;
            cursor: pointer;
            font-size: 13px;
        }
        .link-button:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }
        .section-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }
        .muted {
            color: var(--muted);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="page-shell">
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Totem Bot Admin Panel</h1>
                <p class="page-subtitle">Broadcast updates, manage replies, and monitor users in one place.</p>
            </div>
            <button id="logoutBtn" class="btn-ghost">Logout</button>
        </div>
        <div class="grid">
            <div class="panel-card">
                <div class="section-header">
                    <div>
                        <h2>Broadcast Center</h2>
                        <div class="muted">Send messages, images, and videos to your audience.</div>
                    </div>
                    <div class="tag">Multi-send</div>
                </div>
                <form id="unifiedForm" enctype="multipart/form-data" class="form-section">
                    <div class="mb-3">
                        <label class="form-label">Select Users:</label>
                        <select id="unifiedUserSelect" name="user_ids" multiple class="form-select" style="height:120px;"></select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="unifiedAllUsers">
                        <label class="form-check-label" for="unifiedAllUsers">Send to All Users</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message:</label>
                        <textarea id="unifiedMessage" name="message" class="form-control" rows="5" style="min-height:140px;"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Images:</label>
                        <input type="file" id="unifiedImageFile" name="images" accept="image/*" class="form-control" multiple>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Videos:</label>
                        <input type="file" id="unifiedVideoFile" name="videos" accept="video/*" class="form-control" multiple>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Broadcast</button>
                </form>
                <div id="result" class="mt-3"></div>
                <div id="authError" class="text-danger mt-2"></div>
            </div>
            <div class="panel-card">
                <div class="section-header">
                    <div>
                        <h2>Reply Manager</h2>
                        <div class="muted">Maintain common questions and automated replies.</div>
                    </div>
                    <div class="tag" style="background: rgba(16, 185, 129, 0.12); color: #047857;">Knowledge Base</div>
                </div>
                <form id="addReplyForm" class="row g-2 align-items-center mb-4">
                    <div class="col-12 col-lg">
                        <input type="text" id="questionInput" placeholder="Common question" required class="form-control">
                    </div>
                    <div class="col-12 col-lg">
                        <input type="text" id="replyInput" placeholder="Bot reply" required class="form-control">
                    </div>
                    <div class="col-12 col-lg-auto">
                        <button type="submit" class="btn btn-success w-100">Add Reply</button>
                    </div>
                </form>
                <div class="table-section">
                    <table id="replyTable" class="table table-bordered table-striped align-middle">
                        <thead>
                            <tr><th>Question</th><th>Reply</th><th>Active</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="panel-card mt-4">
            <div class="section-header">
                <div>
                    <h2>User Overview</h2>
                    <div class="muted">Monitor active users and last seen times.</div>
                </div>
                <div class="tag" style="background: rgba(245, 158, 11, 0.12); color: #b45309;">Live</div>
            </div>
            <div class="table-section">
                <table id="userTable" class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr><th>Telegram ID</th><th>Username</th><th>Last Seen</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Reply?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This reply will be removed permanently. Are you sure you want to proceed?
                    <div class="confirm-details">
                        <div class="detail-row">
                            <div class="detail-label">Question</div>
                            <div id="confirmDeleteQuestion" class="detail-value"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Reply</div>
                            <div id="confirmDeleteReply" class="detail-value"></div>
                        </div>
                    </div>
                    <button type="button" id="toggleDeletePreview" class="link-button">View full</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ...existing JavaScript from admin_panel.html...
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        let pendingDeleteId = null;
        let pendingDeleteRow = null;
        let isPreviewExpanded = false;
        const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const confirmDeleteQuestion = document.getElementById('confirmDeleteQuestion');
        const confirmDeleteReply = document.getElementById('confirmDeleteReply');
        const toggleDeletePreview = document.getElementById('toggleDeletePreview');
        const PREVIEW_LIMIT = 140;

        function truncateText(text, limit) {
            if (!text) return "";
            const clean = text.trim();
            if (clean.length <= limit) return clean;
            return `${clean.slice(0, limit).trim()}...`;
        }

        function applyPreview() {
            const qFull = confirmDeleteQuestion.dataset.fullText || "";
            const rFull = confirmDeleteReply.dataset.fullText || "";
            if (isPreviewExpanded) {
                confirmDeleteQuestion.textContent = qFull || "—";
                confirmDeleteReply.textContent = rFull || "—";
                toggleDeletePreview.textContent = "Collapse";
            } else {
                confirmDeleteQuestion.textContent = truncateText(qFull, PREVIEW_LIMIT) || "—";
                confirmDeleteReply.textContent = truncateText(rFull, PREVIEW_LIMIT) || "—";
                toggleDeletePreview.textContent = "View full";
            }
        }

        toggleDeletePreview.onclick = function() {
            isPreviewExpanded = !isPreviewExpanded;
            applyPreview();
        };
        document.getElementById('confirmDeleteBtn').onclick = async function() {
            if (!pendingDeleteId) {
                return;
            }
            await fetch(`/replies/${pendingDeleteId}`, { method: 'DELETE', headers: { 'X-CSRF-Token': csrfToken } });
            if (pendingDeleteRow) {
                pendingDeleteRow.remove();
            }
            pendingDeleteId = null;
            pendingDeleteRow = null;
            deleteModal.hide();
            loadReplies();
        };

        async function loadReplies() {
            const res = await fetch('/replies');
            if (res.status === 401) {
                document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                setTimeout(() => window.location.href = '/admin/login', 1500);
                return;
            }
            const data = await res.json();
            const tbody = document.getElementById('replyTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.replies.forEach(r => {
                const tr = document.createElement('tr');
                // ...existing code...
                const tdQ = document.createElement('td');
                const inputQ = document.createElement('input');
                inputQ.value = r.question;
                inputQ.className = 'form-control';
                tdQ.appendChild(inputQ);
                tr.appendChild(tdQ);
                const tdR = document.createElement('td');
                const inputR = document.createElement('input');
                inputR.value = r.reply;
                inputR.className = 'form-control';
                tdR.appendChild(inputR);
                tr.appendChild(tdR);
                const tdA = document.createElement('td');
                const inputA = document.createElement('input');
                inputA.type = 'checkbox';
                inputA.checked = r.active;
                tdA.appendChild(inputA);
                tr.appendChild(tdA);
                const tdAct = document.createElement('td');
                const actionWrap = document.createElement('div');
                actionWrap.className = 'reply-actions';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn-save';
                saveBtn.setAttribute('data-bs-toggle', 'tooltip');
                saveBtn.setAttribute('data-bs-title', 'Save changes');
                saveBtn.innerHTML = `
                    <span class="btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                    </span>
                    <span class="btn-text">Save</span>
                `;
                saveBtn.onclick = async () => {
                    await fetch(`/replies/${r.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({
                            question: inputQ.value,
                            reply: inputR.value,
                            active: inputA.checked
                        })
                    });
                    loadReplies();
                };
                actionWrap.appendChild(saveBtn);
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-delete';
                delBtn.setAttribute('data-bs-toggle', 'tooltip');
                delBtn.setAttribute('data-bs-title', 'Delete reply');
                delBtn.innerHTML = `
                    <span class="btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M8 6v12"></path>
                            <path d="M16 6v12"></path>
                            <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"></path>
                            <path d="M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </span>
                    <span class="btn-text">Delete</span>
                `;
                delBtn.onclick = () => {
                    pendingDeleteId = r.id;
                    pendingDeleteRow = tr;
                    confirmDeleteQuestion.dataset.fullText = inputQ.value || "";
                    confirmDeleteReply.dataset.fullText = inputR.value || "";
                    isPreviewExpanded = false;
                    applyPreview();
                    deleteModal.show();
                };
                actionWrap.appendChild(delBtn);
                tdAct.appendChild(actionWrap);
                tr.appendChild(tdAct);
                tbody.appendChild(tr);
                new bootstrap.Tooltip(saveBtn);
                new bootstrap.Tooltip(delBtn);
            });
        }
        document.getElementById('addReplyForm').onsubmit = async function(e) {
            e.preventDefault();
            const question = document.getElementById('questionInput').value;
            const reply = document.getElementById('replyInput').value;
            await fetch('/replies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ question, reply })
            });
            document.getElementById('questionInput').value = '';
            document.getElementById('replyInput').value = '';
            loadReplies();
        };
        loadReplies();
        document.getElementById('logoutBtn').onclick = function() {
            fetch('/admin/logout').then(() => {
                window.location.href = '/admin/login';
            });
        };
        async function loadUsers() {
            try {
                const res = await fetch('/users');
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                const select = document.getElementById('unifiedUserSelect');
                select.innerHTML = '';
                data.users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.telegram_id;
                    option.text = u.username ? `${u.username} (${u.telegram_id})` : u.telegram_id;
                    select.appendChild(option);
                });
                const tbody = document.getElementById('userTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    const tdId = document.createElement('td');
                    tdId.textContent = u.telegram_id;
                    const tdUser = document.createElement('td');
                    tdUser.textContent = u.username || '';
                    const tdLast = document.createElement('td');
                    tdLast.textContent = u.last_message_time || '';
                    tr.appendChild(tdId);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdLast);
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('authError').innerText = 'Error loading users.';
            }
        }
        loadUsers();
        document.getElementById('unifiedAllUsers').onchange = function() {
            document.getElementById('unifiedUserSelect').disabled = this.checked;
        };
        document.getElementById('unifiedForm').onsubmit = async function(e) {
            e.preventDefault();
            const all = document.getElementById('unifiedAllUsers').checked;
            let user_ids = [];
            if (!all) {
                user_ids = Array.from(document.getElementById('unifiedUserSelect').selectedOptions).map(o => o.value);
                if (user_ids.length === 0) {
                    document.getElementById('result').innerText = 'Please select at least one user or choose All Users.';
                    return;
                }
            }
            const message = document.getElementById('unifiedMessage').value;
            const imageFiles = document.getElementById('unifiedImageFile').files;
            const videoFiles = document.getElementById('unifiedVideoFile').files;
            if (!message && imageFiles.length === 0 && videoFiles.length === 0) {
                document.getElementById('result').innerText = 'Please provide at least a message, image, or video.';
                return;
            }
            const formData = new FormData();
            formData.append('message', message);
            formData.append('user_ids', all ? (await fetch('/users').then(r=>r.json())).users.map(u=>u.telegram_id).join(',') : user_ids.join(','));
            for (let i = 0; i < imageFiles.length; i++) {
                formData.append('images', imageFiles[i]);
            }
            for (let i = 0; i < videoFiles.length; i++) {
                formData.append('videos', videoFiles[i]);
            }
            const res = await fetch('/send/all/bulk', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken }, body: formData });
            let result = await res.json();
            if (result.success) {
                document.getElementById('result').innerText = ` Sent to ${result.sent.length} user(s).`;
            } else if (result.failed && result.failed.length > 0) {
                document.getElementById('result').innerText = `Some failed: ${JSON.stringify(result.failed)}`;
            } else {
                document.getElementById('result').innerText = JSON.stringify(result);
            }
        };
    </script>
</body>
</html>
