<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Bot Admin Panel</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Fraunces:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-1: #f6f4f1;
            --bg-2: #eef3fb;
            --ink: #1c1b1a;
            --muted: #5b5b62;
            --card: #ffffff;
            --accent: #2563eb;
            --accent-2: #10b981;
            --accent-3: #f59e0b;
            --border: rgba(17, 24, 39, 0.12);
            --shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
        }
        * { box-sizing: border-box; }
        body {
            font-family: "Space Grotesk", system-ui, -apple-system, "Segoe UI", sans-serif;
            color: var(--ink);
            margin: 0;
            background:
                radial-gradient(900px 400px at 10% -10%, rgba(37, 99, 235, 0.12), transparent 60%),
                radial-gradient(800px 360px at 90% 10%, rgba(16, 185, 129, 0.12), transparent 60%),
                linear-gradient(140deg, var(--bg-1), var(--bg-2));
            min-height: 100vh;
        }
        .page-shell {
            padding: 48px 20px 72px;
        }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 26px;
        }
        .page-title {
            font-family: "Fraunces", "Times New Roman", serif;
            font-weight: 700;
            font-size: clamp(28px, 3.2vw, 44px);
            margin: 0;
            letter-spacing: -0.5px;
        }
        .page-subtitle {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 15px;
        }
        .btn-ghost {
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.8);
            color: var(--ink);
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .btn-ghost:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.12);
        }
        .header-actions {
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }
        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 24px;
        }
        @media (min-width: 992px) {
            .grid {
                grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
                align-items: start;
            }
        }
        .panel-card {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 24px;
        }
        .panel-title {
            font-weight: 700;
            font-size: 20px;
            margin-bottom: 14px;
        }
        .panel-title span {
            color: var(--accent);
        }
        .form-section { max-width: none; }
        .table-section { max-width: none; }
        .table-section {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.1);
            color: #1e40af;
            font-size: 12px;
            font-weight: 600;
        }
        .form-control, .form-select {
            border-radius: 12px;
            border-color: rgba(17, 24, 39, 0.16);
            padding: 10px 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: rgba(37, 99, 235, 0.6);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #22c55e);
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 600;
        }
        .file-group {
            display: grid;
            gap: 10px;
        }
        .file-row {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto;
            gap: 10px;
            align-items: center;
        }
        .file-input-wrap {
            display: grid;
            gap: 6px;
        }
        .file-actions {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .add-file-btn {
            border-radius: 999px;
            padding: 6px 14px;
            border: 1px solid rgba(37, 99, 235, 0.3);
            background: rgba(37, 99, 235, 0.1);
            color: #1d4ed8;
            font-weight: 600;
            font-size: 13px;
        }
        .clear-file-btn {
            border-radius: 999px;
            padding: 6px 14px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(148, 163, 184, 0.12);
            color: #475569;
            font-weight: 600;
            font-size: 13px;
        }
        .remove-file-btn {
            border-radius: 999px;
            padding: 6px 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: rgba(148, 163, 184, 0.12);
            color: #475569;
            font-weight: 600;
            font-size: 12px;
        }
        .remove-file-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .file-name {
            font-size: 12px;
            color: #64748b;
        }
        .file-hint {
            color: var(--muted);
            font-size: 12px;
            margin-top: 6px;
        }
        #result {
            font-weight: 600;
            color: #1e40af;
        }
        #authError {
            font-weight: 600;
        }
        .table {
            margin-bottom: 0;
            border-radius: 14px;
            overflow: hidden;
            min-width: 620px;
        }
        .table thead {
            background: #f8fafc;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
        #replyTable input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 6px 10px;
        }
        #pairTable input[type="text"] {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 6px 10px;
        }
        .reply-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        #replyTable button {
            border-radius: 999px;
            font-weight: 600;
            padding: 6px 14px;
            border: 1px solid transparent;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
        }
        #replyTable button .btn-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #replyTable button .btn-icon svg {
            width: 16px;
            height: 16px;
        }
        #replyTable button .btn-text {
            line-height: 1;
        }
        #replyTable button.btn-save {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(59, 130, 246, 0.22));
            color: #1d4ed8;
            border-color: rgba(37, 99, 235, 0.3);
        }
        #replyTable button.btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
        }
        #replyTable button.btn-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.14), rgba(248, 113, 113, 0.2));
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.25);
        }
        #replyTable button.btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.18);
        }
        #replyTable button:focus-visible {
            outline: 2px solid rgba(37, 99, 235, 0.35);
            outline-offset: 2px;
        }
        #pairTable button {
            border-radius: 999px;
            font-weight: 600;
            padding: 6px 14px;
            border: 1px solid transparent;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
        }
        #pairTable button.btn-save {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(59, 130, 246, 0.22));
            color: #1d4ed8;
            border-color: rgba(37, 99, 235, 0.3);
        }
        #pairTable button.btn-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
        }
        #pairTable button.btn-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.14), rgba(248, 113, 113, 0.2));
            color: #b91c1c;
            border-color: rgba(239, 68, 68, 0.25);
        }
        #pairTable button.btn-delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.18);
        }
        #pairTable button.btn-move {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.14), rgba(167, 139, 250, 0.2));
            color: #5b21b6;
            border-color: rgba(139, 92, 246, 0.25);
            padding: 6px 10px;
            min-width: 32px;
            justify-content: center;
        }
        #pairTable button.btn-move:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(139, 92, 246, 0.18);
        }
        .pair-actions {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .confirm-modal .modal-content {
            border-radius: 18px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        .confirm-modal .modal-header {
            border-bottom: none;
        }
        .confirm-modal .modal-footer {
            border-top: none;
        }
        .confirm-modal .btn {
            border-radius: 999px;
            padding: 8px 16px;
            font-weight: 600;
        }
        .confirm-modal .btn-danger {
            background: linear-gradient(135deg, #ef4444, #f97316);
            border: none;
        }
        .confirm-modal .btn-secondary {
            background: rgba(15, 23, 42, 0.08);
            border: none;
            color: #1f2937;
        }
        .confirm-details {
            margin-top: 12px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.04);
            border: 1px dashed rgba(15, 23, 42, 0.08);
            display: grid;
            gap: 10px;
            font-size: 13px;
        }
        .confirm-details .detail-row {
            display: grid;
            gap: 6px;
        }
        .confirm-details .detail-label {
            text-transform: uppercase;
            letter-spacing: 0.7px;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
        }
        .confirm-details .detail-value {
            color: #1f2937;
            word-break: break-word;
        }
        .link-button {
            background: none;
            border: none;
            color: #2563eb;
            font-weight: 600;
            padding: 6px 0 0;
            cursor: pointer;
            font-size: 13px;
        }
        .link-button:hover {
            color: #1d4ed8;
            text-decoration: underline;
        }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }
        .section-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }
        .muted {
            color: var(--muted);
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .page-shell {
                padding: 32px 16px 56px;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
            }
            .header-actions {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: wrap;
            }
            .btn-ghost {
                width: 100%;
                text-align: center;
            }
            .panel-card {
                padding: 18px;
            }
            .table {
                min-width: 560px;
            }
        }
    </style>
</head>
<body>
    <div class="page-shell">
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Telegram Bot Admin Panel</h1>
                <p class="page-subtitle">Broadcast updates, manage replies, and monitor users in one place.</p>
            </div>
            <div class="header-actions">
                <a href="/admin/reset" class="btn-ghost">Reset Password</a>
                <button id="logoutBtn" class="btn-ghost">Logout</button>
            </div>
        </div>
        <div class="grid">
            <div class="panel-card">
                <div class="section-header">
                    <div>
                        <h2>Broadcast Center</h2>
                        <div class="muted">Send messages, images, and videos to your audience.</div>
                    </div>
                    <div class="tag">Multi-send</div>
                </div>
                <form id="unifiedForm" enctype="multipart/form-data" class="form-section">
                    <div class="mb-3">
                        <label class="form-label">Select Users:</label>
                        <select id="unifiedUserSelect" name="user_ids" multiple class="form-select" style="height:120px;"></select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="unifiedAllUsers">
                        <label class="form-check-label" for="unifiedAllUsers">Send to All Users</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message:</label>
                        <textarea id="unifiedMessage" name="message" class="form-control" rows="5" style="min-height:140px;"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="file-actions">
                            <label class="form-label mb-0">Images:</label>
                            <button type="button" id="addImageBtn" class="add-file-btn">Add more</button>
                            <button type="button" id="clearImageBtn" class="clear-file-btn">Clear all</button>
                        </div>
                        <div id="imageInputs" class="file-group">
                            <div class="file-row">
                                <div class="file-input-wrap">
                                    <input type="file" name="images" accept="image/*" class="form-control">
                                    <div class="file-name">No file selected</div>
                                </div>
                                <button type="button" class="remove-file-btn" disabled>Remove</button>
                            </div>
                        </div>
                        <div class="file-hint">Add multiple images using the "Add more" button.</div>
                    </div>
                    <div class="mb-3">
                        <div class="file-actions">
                            <label class="form-label mb-0">Videos:</label>
                            <button type="button" id="addVideoBtn" class="add-file-btn">Add more</button>
                            <button type="button" id="clearVideoBtn" class="clear-file-btn">Clear all</button>
                        </div>
                        <div id="videoInputs" class="file-group">
                            <div class="file-row">
                                <div class="file-input-wrap">
                                    <input type="file" name="videos" accept="video/*" class="form-control">
                                    <div class="file-name">No file selected</div>
                                </div>
                                <button type="button" class="remove-file-btn" disabled>Remove</button>
                            </div>
                        </div>
                        <div class="file-hint">Add multiple videos using the "Add more" button.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Broadcast</button>
                </form>
                <div id="result" class="mt-3"></div>
                <div id="authError" class="text-danger mt-2"></div>
            </div>
            <div class="panel-card">
                <div class="section-header">
                    <div>
                        <h2>Reply Manager</h2>
                        <div class="muted">Maintain common questions and automated replies.</div>
                    </div>
                    <div class="tag" style="background: rgba(16, 185, 129, 0.12); color: #047857;">Knowledge Base</div>
                </div>
                <form id="addReplyForm" class="row g-2 align-items-center mb-4">
                    <div class="col-12 col-lg">
                        <input type="text" id="questionInput" placeholder="Common question" required class="form-control">
                    </div>
                    <div class="col-12 col-lg">
                        <input type="text" id="replyInput" placeholder="Bot reply" required class="form-control">
                    </div>
                    <div class="col-12 col-lg-auto">
                        <button type="submit" class="btn btn-success w-100">Add Reply</button>
                    </div>
                </form>
                <div class="table-section">
                    <table id="replyTable" class="table table-bordered table-striped align-middle">
                        <thead>
                            <tr><th>Question</th><th>Reply</th><th>Active</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="panel-card mt-4">
            <div class="section-header">
                <div>
                    <h2>Signal Pairs Manager</h2>
                    <div class="muted">Add, edit, or remove currency pairs shown in /futuresignal and /currencycoveter.</div>
                </div>
                <div class="tag" style="background: rgba(139, 92, 246, 0.12); color: #6d28d9;">Pairs</div>
            </div>
            <form id="addPairForm" class="row g-2 align-items-center mb-4">
                <div class="col-12 col-lg">
                    <input type="text" id="pairNameInput" placeholder="Pair name (e.g. EURUSD)" required class="form-control">
                </div>
                <div class="col-12 col-lg">
                    <input type="text" id="pairDisplayInput" placeholder="Display name (e.g. EURUSD_otc)" class="form-control">
                </div>
                <div class="col-12 col-lg-auto">
                    <button type="submit" class="btn btn-success w-100">Add Pair</button>
                </div>
            </form>
            <div class="table-section">
                <table id="pairTable" class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr><th>#</th><th>Pair Name</th><th>Display Name</th><th>Active</th><th>Actions</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="panel-card mt-4">
            <div class="section-header">
                <div>
                    <h2>Start Message</h2>
                    <div class="muted">Edit the single /start reply shown to users.</div>
                </div>
                <div class="tag" style="background: rgba(37, 99, 235, 0.12); color: #1d4ed8;">Bot Flow</div>
            </div>
            <form id="startMessageForm" class="form-section">
                <div class="mb-3">
                    <label class="form-label">/start reply</label>
                    <textarea id="startMessageInput" class="form-control" rows="6" placeholder="Enter the /start message"></textarea>
                    <div class="file-hint">Line breaks will be preserved.</div>
                </div>
                <button type="submit" class="btn btn-primary">Save Start Message</button>
                <div id="startMessageResult" class="mt-2"></div>
            </form>
        </div>
        <div class="panel-card mt-4">
            <div class="section-header">
                <div>
                    <h2>User Overview</h2>
                    <div class="muted">Monitor active users and last seen times.</div>
                </div>
                <div class="tag" style="background: rgba(245, 158, 11, 0.12); color: #b45309;">Live</div>
            </div>
            <div class="table-section">
                <table id="userTable" class="table table-bordered table-striped align-middle">
                    <thead>
                        <tr><th>Telegram ID</th><th>Username</th><th>Last Seen</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content confirm-modal">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Reply?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    This reply will be removed permanently. Are you sure you want to proceed?
                    <div class="confirm-details">
                        <div class="detail-row">
                            <div class="detail-label">Question</div>
                            <div id="confirmDeleteQuestion" class="detail-value"></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Reply</div>
                            <div id="confirmDeleteReply" class="detail-value"></div>
                        </div>
                    </div>
                    <button type="button" id="toggleDeletePreview" class="link-button">View full</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ...existing JavaScript from admin_panel.html...
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        let pendingDeleteId = null;
        let pendingDeleteRow = null;
        let isPreviewExpanded = false;
        const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const confirmDeleteQuestion = document.getElementById('confirmDeleteQuestion');
        const confirmDeleteReply = document.getElementById('confirmDeleteReply');
        const toggleDeletePreview = document.getElementById('toggleDeletePreview');
        const PREVIEW_LIMIT = 140;
        const imageInputs = document.getElementById('imageInputs');
        const videoInputs = document.getElementById('videoInputs');
        const addImageBtn = document.getElementById('addImageBtn');
        const addVideoBtn = document.getElementById('addVideoBtn');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const clearVideoBtn = document.getElementById('clearVideoBtn');
        const startMessageInput = document.getElementById('startMessageInput');
        const startMessageResult = document.getElementById('startMessageResult');
        const startMessageForm = document.getElementById('startMessageForm');

        function truncateText(text, limit) {
            if (!text) return "";
            const clean = text.trim();
            if (clean.length <= limit) return clean;
            return `${clean.slice(0, limit).trim()}...`;
        }

        function applyPreview() {
            const qFull = confirmDeleteQuestion.dataset.fullText || "";
            const rFull = confirmDeleteReply.dataset.fullText || "";
            if (isPreviewExpanded) {
                confirmDeleteQuestion.textContent = qFull || "—";
                confirmDeleteReply.textContent = rFull || "—";
                toggleDeletePreview.textContent = "Collapse";
            } else {
                confirmDeleteQuestion.textContent = truncateText(qFull, PREVIEW_LIMIT) || "—";
                confirmDeleteReply.textContent = truncateText(rFull, PREVIEW_LIMIT) || "—";
                toggleDeletePreview.textContent = "View full";
            }
        }

        toggleDeletePreview.onclick = function() {
            isPreviewExpanded = !isPreviewExpanded;
            applyPreview();
        };

        function addFileRow(container, accept) {
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <div class="file-input-wrap">
                    <input type="file" name="${accept === 'image' ? 'images' : 'videos'}" accept="${accept === 'image' ? 'image/*' : 'video/*'}" class="form-control">
                    <div class="file-name">No file selected</div>
                </div>
                <button type="button" class="remove-file-btn">Remove</button>
            `;
            const input = row.querySelector('input[type="file"]');
            const nameLabel = row.querySelector('.file-name');
            const updateName = () => {
                const files = Array.from(input.files || []);
                nameLabel.textContent = files.length ? files.map(f => f.name).join(', ') : 'No file selected';
            };
            input.addEventListener('change', updateName);
            updateName();
            const removeBtn = row.querySelector('.remove-file-btn');
            removeBtn.onclick = () => {
                row.remove();
                updateRemoveButtons(container);
            };
            container.appendChild(row);
            updateRemoveButtons(container);
        }

        function updateRemoveButtons(container) {
            const rows = container.querySelectorAll('.file-row');
            rows.forEach((row, index) => {
                const btn = row.querySelector('.remove-file-btn');
                btn.disabled = rows.length === 1 && index === 0;
            });
        }

        function initFileRows(container) {
            container.querySelectorAll('.file-row').forEach(row => {
                const input = row.querySelector('input[type="file"]');
                const nameLabel = row.querySelector('.file-name');
                const updateName = () => {
                    const files = Array.from(input.files || []);
                    nameLabel.textContent = files.length ? files.map(f => f.name).join(', ') : 'No file selected';
                };
                input.addEventListener('change', updateName);
                updateName();
            });
        }

        function resetFileRows(container, accept) {
            container.innerHTML = '';
            addFileRow(container, accept);
        }

        addImageBtn.onclick = () => addFileRow(imageInputs, 'image');
        addVideoBtn.onclick = () => addFileRow(videoInputs, 'video');
        clearImageBtn.onclick = () => resetFileRows(imageInputs, 'image');
        clearVideoBtn.onclick = () => resetFileRows(videoInputs, 'video');
        initFileRows(imageInputs);
        initFileRows(videoInputs);
        updateRemoveButtons(imageInputs);
        updateRemoveButtons(videoInputs);
        document.getElementById('confirmDeleteBtn').onclick = async function() {
            if (!pendingDeleteId) {
                return;
            }
            await fetch(`/replies/${pendingDeleteId}`, { method: 'DELETE', headers: { 'X-CSRF-Token': csrfToken } });
            if (pendingDeleteRow) {
                pendingDeleteRow.remove();
            }
            pendingDeleteId = null;
            pendingDeleteRow = null;
            deleteModal.hide();
            loadReplies();
        };

        async function loadReplies() {
            const res = await fetch('/replies');
            if (res.status === 401) {
                document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                setTimeout(() => window.location.href = '/admin/login', 1500);
                return;
            }
            const data = await res.json();
            const tbody = document.getElementById('replyTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.replies.forEach(r => {
                const tr = document.createElement('tr');
                // ...existing code...
                const tdQ = document.createElement('td');
                const inputQ = document.createElement('input');
                inputQ.value = r.question;
                inputQ.className = 'form-control';
                tdQ.appendChild(inputQ);
                tr.appendChild(tdQ);
                const tdR = document.createElement('td');
                const inputR = document.createElement('input');
                inputR.value = r.reply;
                inputR.className = 'form-control';
                tdR.appendChild(inputR);
                tr.appendChild(tdR);
                const tdA = document.createElement('td');
                const inputA = document.createElement('input');
                inputA.type = 'checkbox';
                inputA.checked = r.active;
                tdA.appendChild(inputA);
                tr.appendChild(tdA);
                const tdAct = document.createElement('td');
                const actionWrap = document.createElement('div');
                actionWrap.className = 'reply-actions';
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn-save';
                saveBtn.setAttribute('data-bs-toggle', 'tooltip');
                saveBtn.setAttribute('data-bs-title', 'Save changes');
                saveBtn.innerHTML = `
                    <span class="btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                    </span>
                    <span class="btn-text">Save</span>
                `;
                saveBtn.onclick = async () => {
                    await fetch(`/replies/${r.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                        body: JSON.stringify({
                            question: inputQ.value,
                            reply: inputR.value,
                            active: inputA.checked
                        })
                    });
                    loadReplies();
                };
                actionWrap.appendChild(saveBtn);
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-delete';
                delBtn.setAttribute('data-bs-toggle', 'tooltip');
                delBtn.setAttribute('data-bs-title', 'Delete reply');
                delBtn.innerHTML = `
                    <span class="btn-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M8 6v12"></path>
                            <path d="M16 6v12"></path>
                            <path d="M5 6l1 14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-14"></path>
                            <path d="M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </span>
                    <span class="btn-text">Delete</span>
                `;
                delBtn.onclick = () => {
                    pendingDeleteId = r.id;
                    pendingDeleteRow = tr;
                    confirmDeleteQuestion.dataset.fullText = inputQ.value || "";
                    confirmDeleteReply.dataset.fullText = inputR.value || "";
                    isPreviewExpanded = false;
                    applyPreview();
                    deleteModal.show();
                };
                actionWrap.appendChild(delBtn);
                tdAct.appendChild(actionWrap);
                tr.appendChild(tdAct);
                tbody.appendChild(tr);
                new bootstrap.Tooltip(saveBtn);
                new bootstrap.Tooltip(delBtn);
            });
        }

        async function loadStartMessage() {
            if (!startMessageInput) {
                return;
            }
            try {
                const res = await fetch('/settings/start-message');
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                startMessageInput.value = data.message || '';
            } catch (e) {
                startMessageResult.textContent = 'Error loading start message.';
            }
        }

        if (startMessageForm) {
            startMessageForm.onsubmit = async function(e) {
                e.preventDefault();
                const message = startMessageInput.value || '';
                if (!message.trim()) {
                    startMessageResult.textContent = 'Message is required.';
                    return;
                }
                const res = await fetch('/settings/start-message', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ message })
                });
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                if (res.ok) {
                    startMessageResult.textContent = 'Start message saved.';
                    startMessageInput.value = data.message || message;
                } else {
                    startMessageResult.textContent = data.detail || data.error || 'Error saving start message.';
                }
            };
        }
        document.getElementById('addReplyForm').onsubmit = async function(e) {
            e.preventDefault();
            const question = document.getElementById('questionInput').value;
            const reply = document.getElementById('replyInput').value;
            await fetch('/replies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ question, reply })
            });
            document.getElementById('questionInput').value = '';
            document.getElementById('replyInput').value = '';
            loadReplies();
        };
        loadReplies();
        loadStartMessage();
        document.getElementById('logoutBtn').onclick = function() {
            fetch('/admin/logout').then(() => {
                window.location.href = '/admin/login';
            });
        };
        async function loadUsers() {
            try {
                const res = await fetch('/users');
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                const select = document.getElementById('unifiedUserSelect');
                select.innerHTML = '';
                data.users.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.telegram_id;
                    option.text = u.username ? `${u.username} (${u.telegram_id})` : u.telegram_id;
                    select.appendChild(option);
                });
                const tbody = document.getElementById('userTable').querySelector('tbody');
                tbody.innerHTML = '';
                data.users.forEach(u => {
                    const tr = document.createElement('tr');
                    const tdId = document.createElement('td');
                    tdId.textContent = u.telegram_id;
                    const tdUser = document.createElement('td');
                    tdUser.textContent = u.username || '';
                    const tdLast = document.createElement('td');
                    tdLast.textContent = u.last_message_time || '';
                    tr.appendChild(tdId);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdLast);
                    tbody.appendChild(tr);
                });
            } catch (e) {
                document.getElementById('authError').innerText = 'Error loading users.';
            }
        }
        loadUsers();

        // ================= SIGNAL PAIRS MANAGER =================
        async function loadPairs() {
            try {
                const res = await fetch('/signal-pairs');
                if (res.status === 401) {
                    document.getElementById('authError').innerText = 'Session expired. Please log in again.';
                    setTimeout(() => window.location.href = '/admin/login', 1500);
                    return;
                }
                const data = await res.json();
                const tbody = document.getElementById('pairTable').querySelector('tbody');
                tbody.innerHTML = '';
                const pairs = data.pairs || [];
                pairs.forEach((p, idx) => {
                    const tr = document.createElement('tr');

                    // # column (sort order)
                    const tdNum = document.createElement('td');
                    tdNum.textContent = idx + 1;
                    tdNum.style.fontWeight = '600';
                    tdNum.style.textAlign = 'center';
                    tdNum.style.width = '50px';
                    tr.appendChild(tdNum);

                    // Pair Name
                    const tdName = document.createElement('td');
                    const inputName = document.createElement('input');
                    inputName.type = 'text';
                    inputName.value = p.pair_name;
                    inputName.className = 'form-control';
                    tdName.appendChild(inputName);
                    tr.appendChild(tdName);

                    // Display Name
                    const tdDisplay = document.createElement('td');
                    const inputDisplay = document.createElement('input');
                    inputDisplay.type = 'text';
                    inputDisplay.value = p.display_name;
                    inputDisplay.className = 'form-control';
                    tdDisplay.appendChild(inputDisplay);
                    tr.appendChild(tdDisplay);

                    // Active
                    const tdActive = document.createElement('td');
                    tdActive.style.textAlign = 'center';
                    const inputActive = document.createElement('input');
                    inputActive.type = 'checkbox';
                    inputActive.checked = p.active;
                    tdActive.appendChild(inputActive);
                    tr.appendChild(tdActive);

                    // Actions
                    const tdAct = document.createElement('td');
                    const actionWrap = document.createElement('div');
                    actionWrap.className = 'pair-actions';

                    // Move Up
                    const upBtn = document.createElement('button');
                    upBtn.className = 'btn-move';
                    upBtn.innerHTML = '&#9650;';
                    upBtn.title = 'Move up';
                    upBtn.disabled = idx === 0;
                    upBtn.onclick = async () => {
                        if (idx === 0) return;
                        const prevPair = pairs[idx - 1];
                        const curOrder = p.sort_order;
                        const prevOrder = prevPair.sort_order;
                        await Promise.all([
                            fetch(`/signal-pairs/${p.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                                body: JSON.stringify({ pair_name: p.pair_name, display_name: p.display_name, active: p.active ? 1 : 0, sort_order: prevOrder })
                            }),
                            fetch(`/signal-pairs/${prevPair.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                                body: JSON.stringify({ pair_name: prevPair.pair_name, display_name: prevPair.display_name, active: prevPair.active ? 1 : 0, sort_order: curOrder })
                            })
                        ]);
                        loadPairs();
                    };
                    actionWrap.appendChild(upBtn);

                    // Move Down
                    const downBtn = document.createElement('button');
                    downBtn.className = 'btn-move';
                    downBtn.innerHTML = '&#9660;';
                    downBtn.title = 'Move down';
                    downBtn.disabled = idx === pairs.length - 1;
                    downBtn.onclick = async () => {
                        if (idx === pairs.length - 1) return;
                        const nextPair = pairs[idx + 1];
                        const curOrder = p.sort_order;
                        const nextOrder = nextPair.sort_order;
                        await Promise.all([
                            fetch(`/signal-pairs/${p.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                                body: JSON.stringify({ pair_name: p.pair_name, display_name: p.display_name, active: p.active ? 1 : 0, sort_order: nextOrder })
                            }),
                            fetch(`/signal-pairs/${nextPair.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                                body: JSON.stringify({ pair_name: nextPair.pair_name, display_name: nextPair.display_name, active: nextPair.active ? 1 : 0, sort_order: curOrder })
                            })
                        ]);
                        loadPairs();
                    };
                    actionWrap.appendChild(downBtn);

                    // Save
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'btn-save';
                    saveBtn.innerHTML = '<span class="btn-text">Save</span>';
                    saveBtn.onclick = async () => {
                        const res = await fetch(`/signal-pairs/${p.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                            body: JSON.stringify({
                                pair_name: inputName.value.trim(),
                                display_name: inputDisplay.value.trim(),
                                active: inputActive.checked ? 1 : 0
                            })
                        });
                        if (res.ok) loadPairs();
                    };
                    actionWrap.appendChild(saveBtn);

                    // Delete
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn-delete';
                    delBtn.innerHTML = '<span class="btn-text">Delete</span>';
                    delBtn.onclick = async () => {
                        if (!confirm(`Delete pair "${p.pair_name}"?`)) return;
                        await fetch(`/signal-pairs/${p.id}`, {
                            method: 'DELETE',
                            headers: { 'X-CSRF-Token': csrfToken }
                        });
                        loadPairs();
                    };
                    actionWrap.appendChild(delBtn);

                    tdAct.appendChild(actionWrap);
                    tr.appendChild(tdAct);
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Error loading pairs:', e);
            }
        }

        document.getElementById('addPairForm').onsubmit = async function(e) {
            e.preventDefault();
            const pairName = document.getElementById('pairNameInput').value.trim();
            const displayName = document.getElementById('pairDisplayInput').value.trim();
            if (!pairName) return;
            const res = await fetch('/signal-pairs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
                body: JSON.stringify({ pair_name: pairName, display_name: displayName || pairName })
            });
            if (res.ok) {
                document.getElementById('pairNameInput').value = '';
                document.getElementById('pairDisplayInput').value = '';
                loadPairs();
            } else {
                const data = await res.json();
                alert(data.detail || 'Error adding pair');
            }
        };
        loadPairs();

        document.getElementById('unifiedAllUsers').onchange = function() {
            document.getElementById('unifiedUserSelect').disabled = this.checked;
        };
        document.getElementById('unifiedForm').onsubmit = async function(e) {
            e.preventDefault();
            const all = document.getElementById('unifiedAllUsers').checked;
            let user_ids = [];
            if (!all) {
                user_ids = Array.from(document.getElementById('unifiedUserSelect').selectedOptions).map(o => o.value);
                if (user_ids.length === 0) {
                    document.getElementById('result').innerText = 'Please select at least one user or choose All Users.';
                    return;
                }
            }
            const message = document.getElementById('unifiedMessage').value;
            const imageFiles = [];
            imageInputs.querySelectorAll('input[type="file"]').forEach(input => {
                Array.from(input.files).forEach(file => imageFiles.push(file));
            });
            const videoFiles = [];
            videoInputs.querySelectorAll('input[type="file"]').forEach(input => {
                Array.from(input.files).forEach(file => videoFiles.push(file));
            });
            if (!message && imageFiles.length === 0 && videoFiles.length === 0) {
                document.getElementById('result').innerText = 'Please provide at least a message, image, or video.';
                return;
            }
            const formData = new FormData();
            formData.append('message', message);
            formData.append('user_ids', all ? (await fetch('/users').then(r=>r.json())).users.map(u=>u.telegram_id).join(',') : user_ids.join(','));
            for (let i = 0; i < imageFiles.length; i++) {
                formData.append('images', imageFiles[i]);
            }
            for (let i = 0; i < videoFiles.length; i++) {
                formData.append('videos', videoFiles[i]);
            }
            const res = await fetch('/send/all/bulk', { method: 'POST', headers: { 'X-CSRF-Token': csrfToken }, body: formData });
            let result = await res.json();
            if (result.success) {
                document.getElementById('result').innerText = ` Sent to ${result.sent.length} user(s).`;
            } else if (result.failed && result.failed.length > 0) {
                document.getElementById('result').innerText = `Some failed: ${JSON.stringify(result.failed)}`;
            } else {
                document.getElementById('result').innerText = JSON.stringify(result);
            }
        };
    </script>
</body>
</html>
